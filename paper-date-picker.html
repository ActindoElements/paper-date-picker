<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../core-media-query/core-media-query.html">
<link rel="import" href="../core-scroll-threshold/core-scroll-threshold.html">
<link rel="import" href="../paper-item/paper-item.html">
<link rel="import" href="../core-animated-pages/core-animated-pages.html">
<link rel="import" href="../core-list/core-list.html">

<!--
Material Design [Pickers](http://www.google.com/design/spec/components/pickers.html)

Provides a responsive date picker based on the material design spec. This
component aims to be a clone of the date picker found on Google Calendar for
Android. 
-->

<script src="../moment/min/moment-with-locales.min.js"></script>
<script src="../deep-diff/releases/deep-diff-0.3.0.min.js"></script>

<polymer-element name="paper-date-picker" attributes="locale minYear maxYear">
  <template>
    <core-media-query query="max-width: 560px" queryMatches="{{narrow}}"></core-media-query>
    <style shim-shadowdom>
      :host {
        -webkit-font-smoothing: antialiased;
        display: inline-block;
        color: #757575;
        font-size: 14px;
      }

      /** Horizontal ******************/
      #datePicker {
        width: 512px;
        height: 248px;
      }
      #heading, 
      #pages {
        width: 256px !important;
        height: 248px;
      }

      /** Narrow *********************/
      :host[narrow] #datePicker {
        width: 280px;
        height: 496px;
      }
      :host[narrow] #heading,
      :host[narrow] #pages {
        width: 280px !important;
      }

      /** Heading ********************/
      #heading {
        color: #fff; 
        background: #009688;
        text-align: center;
        font-kerning: auto;
        letter-spacing: normal;
      }
      #heading .weekday {
        background :#00796b;
        padding: 8px;
        font-size: 14px;
      }
      #heading .date {
        cursor: pointer;
        padding: 24px;
        font-weight: normal;
      }
      #heading .date .month {
        cursor: pointer;
        font-size: 24px;
        text-transform: uppercase;
      }
      #heading .date .day {
        cursor: pointer;
        font-size: 78px;
      }
      #heading .date .year {
        font-size: 24px;
        color: #8acfc8;
      }

      #pages section core-list {
        overflow-x: hidden; 
      }

      /** Calendar *******************/
      #pages {
        background: #fff;
      }
      #calendarList .calendar-month {
      }
      #calendarList .month-name {
        cursor: pointer;
        padding: 8px;
        font-size: 14px;
        text-align: center;
        font-weight: bold;
      }
      #calendarList .month-weekdays {
        font-size: 13px;
        font-weight: bold;
      }
      #calendarList .month-weekdays .day {
        height: 20px;
        line-height: 20px;
        cursor: pointer;
      }
      #calendarList .day {
        width: 34px;
        height: 32px;
        min-width: 34px;
        text-align: center;
        vertical-align: middle;
        line-height: 34px;
      }
      #calendarList .day.today:not(.selected) {
        color: #009688;
        font-weight: 500;
      }
      paper-item.selected {
        background: #009688;
        color: #fff;
      }
      #calendarList paper-item {
        border-radius: 18px;
      }
      paper-item.selected {
        color
      }
      paper-item /deep/ .button-content {
        padding: 0;
      }
      paper-item /deep/ paper-ripple {
        border-radius: 18px;
        width: 34px;
        height: 32px;
      }

      #yearList .year div {
        display: block;
        width: 64px;
        height: 64px;
        border-radius: 32px;
      }

    </style>
    <div id="datePicker" layout vertical?="{{narrow}}" horizontal?="{{!narrow}}">
      <template if="{{showHeading}}">
        <div id="heading" class="heading-content" layout vertical>
          <div class="weekday">{{value|dateFormat('dddd')}}</div>
          <div class="date" flex layout vertical justified>
            <div class="month" on-tap="{{changeMonth}}">{{value|dateFormat('MMM')}}</div>
            <div class="day" on-tap="{{changeDay}}">{{value|dateFormat('D')}}</div>
            <div class="year" on-tap="{{changeYear}}">{{value|dateFormat('YYYY')}}</div>
          </div>
        </div>
      </template>
      <core-animated-pages selectedProperty="active" transitions="cross-fade" id="pages" notap relative>
        <section id="chooseDay" fit>
          <core-scroll-threshold id="calendarListThreshold" scrollTarget="{{$.calendarList}}" 
            lowerThreshold="200" upperThreshold="200" on-lower-trigger="{{loadMoreLower}}" on-upper-trigger="{{loadMoreUpper}}"></core-scroll-threshold>
          <core-list id="calendarList" data="{{days}}" groups="{{months}}" selection="{{selectedDate}}" grid width="34" height="32" cross-fade fit>
            <template>
              <div class="divider" divider>
                <div class="month-name" on-press="{{scrollToMonth(model.year, model.month)}}">{{monthNames[groupModel.month]}} {{groupModel.year}}</div>
                <div class="month-weekdays" layout horizontal>
                  <template repeat="{{weekday in weekdays}}">
                    <div class="day">{{weekday[0]}}</div>
                  </template>
                </div>
              </div>
              <paper-item disabled?="{{!model.date}}" class="day {{ {today: model.isToday, selected: selected} | tokenList }}" layout vertical center>
                <div>{{model.date|dateFormat('D')}}</div>
              </paper-item>
            </template>
          </core-list>
        </section>
        <section id="choseMonth" fit>
          <div cross-fade>
            TODO: choose month
          </div>
        </section>
        <section id="chooseYear" fit>
          <core-list id="yearList" data="{{years}}" cross-fade fit>
            <template>
              <paper-item class="year" class="{{ {selected: selected} | tokenList}}"><div>{{model.year}}</div></paper-item>
            </template>
          </core-list>
        </section>
      </core-animated-pages>
    </div>
  </template>

  <script>
    Polymer("paper-date-picker", {
      publish: {
        locale: '',
        showHeading: true,
        narrow: {type: 'boolean', value: false, reflect: true},
      },
      observe: {
        '$.calendarList._viewportSize': '_viewportSizeChanged'
      },
      localeChanged: function() {
        moment.locale(this.locale);
      },
      dateClicked: function(e) {
        var element = e.originalTarget ? e.originalTarget : e.toElement;
      },
      ready: function() {
        this.days = [];
        this.months = [];
        this.years = [];
        this.today = new Date();
        this.today.setHours(0, 0, 0, 0);
        this.narrow = false;
        this.weekdays = moment.weekdays();
        this.monthNames = moment.months();
        this.isTouch = 'ontouchstart' in window;
        this.localeChanged();

        if (!this.value) {
          this.value = new Date();
        }
      
        // prepopulate with +/- two months
        var prepopulate = 2;
        var initialMonth = new Date(this.value.getFullYear(), this.value.getMonth() - prepopulate) 
        this.populateCalendar(initialMonth, 1 + (prepopulate * 2));

        // scroll to the current date
        this.scrollToDate();
      },
      loadMoreUpper: function(e) {
        console.log('hit upper threshold');
        // get prev month
        var date = new Date(this._listStartMonth.getTime());
        date.setMonth(date.getMonth()-1);
        this.populateCalendar(date, -2);
        e.target.clearUpper();
      },
      loadMoreLower: function(e) {
        console.log('hit lower threshold');
        // get next month
        var date = new Date(this._listStartMonth.getTime());
        date.setMonth(date.getMonth()+1);
        this.populateCalendar(date, 2);
        e.target.clearLower();
      },
      populateCalendar: function(startMonth, count) {
        // negative count populates at the front of the list, positive count at the end.
        var month, date, days, padStart, padEnd, daysInMonth, push, m, d, n, s;
        s = count < 0 ? -1 : 1;
        push = count < 0 ? 'unshift' : 'push';
        count = Math.abs(count)
        for (n=0; n<count; n++) {
          // get last day of the month
          m = startMonth.getMonth() + (n * s);
          month = new Date(startMonth.getFullYear(), m);
          padStart = month.getDay();
          year = month.getFullYear();
          monthIdx = month.getMonth();

          if (!this._listStartMonth || month < this._listStartMonth) {
            this._listStartMonth = month;
          }

          days = [];
          // add "padding" days
          for (d=0; d<padStart; d++) {
            days.push({date: null});
          }
          // add actual days 
          d = 1;
          while (month.getMonth() == monthIdx) {
            date = new Date(year, monthIdx, d);
            days.push({
              date: date,
              isToday: date.getTime() == this.today.getTime()
            });
            month.setDate(++d);
          }
          // set month back one day
          month.setDate(0);

          // use push/unshift when appropriate
          this.months[push]({
            month: month.getMonth(),
            year: month.getFullYear(),
          });
          this.days[push](days);
        }
      },
      getMonthIdx: function(year, month) {
        var yearDiff = (year - this._listStartMonth.getFullYear());
        var monthDiff = (month - this._listStartMonth.getMonth());
        return (yearDiff * 12) + monthDiff;
      },
      changeDay: function() {
        this.$.pages.selected = 0;
      },
      changeMonth: function() {
        this.$.pages.selected = 1;
      },
      changeYear: function() {
        this.$.pages.selected = 2;
      },
      scrollToMonth: function(year, month) {
        var idx = this.getMonthIdx(year, month);
        var cal = this.$.calendarList;
        this.addEventListener('viewport-ready', function() {
          cal.scrollToGroup(idx);
        });
      },
      scrollToDate: function(date) {
        if (!date) {
          date = this.value;
        }
        this.scrollToMonth(date.getFullYear(), date.getMonth());
      },
      _viewportSizeChanged: function() {
        if (!this._viewportReady) {
          this._viewportReady = true;
          this.fire('viewport-ready');
        }
      },
      selectedDateChanged: function() {
        this.value = this.selectedDate.date;
      },
      selectedYearChanged: function() {
        console.log('year changed');
      },
      valueChanged: function() {
        console.log('valueChanged: ', this.value);
      },
      updateSize: function() {
        this.$.calendarList.updateSize();
      }
    });

    PolymerExpressions.prototype.dateFormat = function(date, format) {
      if (!date) return '';
      return moment(date).format(format);
    };

    /**
     * TODO
     * When we call scrollToGroup() after the  core-list is initialized (or as
     * we currently understand it to be  initialized), it hides the groups before
     * that group. When we call the  same function after we manually wait for
     * things to load and call it in  the console, it scrolls as expected and
     * does not hide anything.
     * 
     * To figure out why, we need to compare the state of the calendarList
     * object when we DON'T call scrollToGroup(), to its state when we DO call
     * scrollToGroup(). Then we can figure out what the hell is causing the
     * items to be hidden.
     */

    window.serialize = function(obj) {
      var func = function(key, val) {
        if (!key) return val;
        if (val === null) return 'null';
        if (val === undefined) return 'undefined';

        var t = val.constructor.name;
        var types = ['Number', 'Array', 'String']
        if (types.indexOf[t] > -1) {
          return val;
        }
        return val.toString();
      };
      json = JSON.stringify(obj, func);
      return JSON.parse(json);
    }

  </script>
</polymer-element>
