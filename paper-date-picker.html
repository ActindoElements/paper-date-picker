<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../core-media-query/core-media-query.html">
<link rel="import" href="../core-selector/core-selector.html">
<link rel="import" href="../paper-item/paper-item.html">
<link rel="import" href="../core-animated-pages/core-animated-pages.html">
<link rel="import" href="../core-list/core-list.html">

<!--
Material Design [Pickers](http://www.google.com/design/spec/components/pickers.html)

Provides a responsive date picker based on the material design spec. This
component aims to be a clone of the date picker found on Google Calendar for
Android. 
-->

<script src="../moment/min/moment-with-locales.min.js"></script>

<polymer-element name="paper-date-picker" attributes="locale minYear maxYear">
  <template>
    <core-media-query query="max-width: 560px" queryMatches="{{narrow}}"></core-media-query>
    <style shim-shadowdom>
      :host {
        -webkit-font-smoothing: antialiased;
        display: inline-block;
        color: #757575;
        font-size: 14px;
      }

      /** Horizontal ******************/
      #datePicker {
        width: 512px;
        height: 248px;
      }
      #heading, 
      #pages {
        width: 256px !important;
        height: 248px;
      }

      /** Narrow *********************/
      :host[narrow] #datePicker {
        width: 280px;
        height: 496px;
      }
      :host[narrow] #heading,
      :host[narrow] #pages {
        width: 280px !important;
      }

      /** Heading ********************/
      #heading {
        color: #fff; 
        background: #009688;
        text-align: center;
        font-kerning: auto;
        letter-spacing: normal;
      }
      #heading .weekday {
        background :#00796b;
        padding: 8px;
        font-size: 14px;
      }
      #heading .date {
        cursor: pointer;
        padding: 24px;
        font-weight: normal;
      }
      #heading .date .month {
        cursor: pointer;
        font-size: 24px;
        text-transform: uppercase;
      }
      #heading .date .day {
        cursor: pointer;
        font-size: 78px;
      }
      #heading .date .year {
        font-size: 24px;
        color: #8acfc8;
      }

      /** Calendar *******************/
      #pages {
        background: #fff;
      }
      #calendarList .calendar-month {
      }
      #calendarList .month-name {
        cursor: pointer;
        padding: 8px;
        font-size: 14px;
        text-align: center;
        font-weight: bold;
      }
      #calendarList .month-weekdays {
        padding: 0 6px;
        font-size: 13px;
        font-weight: bold;
      }
      #calendarList .month-days {
        padding: 0 6px;
        margin-bottom: 6px;
      }
      #calendarList .day,
      #calendarList .day div {
        width: 34px;
        height: 32px;
        min-width: 34px;
        text-align: center;
        vertical-align: middle;
        line-height: 34px;
      }
      paper-item /deep/ .button-content {
        padding: 0;
      }
      paper-item /deep/ paper-ripple {
        border-radius: 18px;
        width: 34px;
        height: 32px;
      }
      #calendarList .month-weekdays .day {
        height: 20px;
        line-height: 20px;
        cursor: pointer;
      }
      #calendarList .month-days .day.today {
        color: #009688;
        font-weight: 500;
      }
      #calendarList .month-days .day.selected {
        color: #fff; 
        background: #009688;
        border-radius: 18px;
      }

      /* hide the scrollbar */
      #pages {
        overflow: hidden;
      }
      #calendarList {
        width: 280px;
      }

    </style>
    <core-selector id="selector" target="{{$.calendarList}}" itemsSelector=".month-days .day:not(.empty)" selectedClass="selected" selectedModel="{{selectedDate}}"></core-selector>
    <div id="datePicker" layout vertical?="{{narrow}}" horizontal?="{{!narrow}}">
      <template if="{{showHeading}}">
        <div id="heading" class="heading-content" layout vertical>
          <div class="weekday">{{value|dateFormat('dddd')}}</div>
          <div class="date" flex layout vertical justified>
            <div class="month" on-tap="{{changeMonth}}">{{value|dateFormat('MMM')}}</div>
            <div class="day" on-tap="{{changeDay}}">{{value|dateFormat('D')}}</div>
            <div class="year" on-tap="{{changeYear}}">{{value|dateFormat('YYYY')}}</div>
          </div>
        </div>
      </template>
      <core-animated-pages selectedProperty="active" transitions="cross-fade" id="pages" notap relative>
        <section id="chooseDay" fit>
          <core-list id="calendarList" data="{{months}}" selectionEnabled="false" cross-fade fit>
            <template>
              <div class="calendar-month page-content">
                <div class="month-name" on-press="{{scrollToMonth(model.year, model.month)}}">{{monthNames[model.month]}} {{model.year}}</div>
                <div class="month-weekdays" layout horizontal>
                  <template repeat="{{weekday in weekdays}}">
                    <div class="day">{{weekday[0]}}</div>
                  </template>
                </div>
                <div class="month-days" layout horizontal wrap>
                  <template repeat="{{model.days}}">
                    <paper-item class="{{ {day: true, today: isToday, empty: !date} | tokenList}}"><div>{{date|dateFormat('D')}}</div></paper-item>
                  </template>
                </div>
              </div>
            </template>
          </core-list>
        </section>
        <section id="choseMonth" fit>
          <div cross-fade>
            <br>
            TODO: choose month
          </div>
        </section>
        <section id="chooseYear" fit>
          <div cross-fade>
            <br><br>
            TODO: choose year
          </div>
        </section>
      </core-animated-pages>
    </div>
  </template>

  <script>
    Polymer("paper-date-picker", {
      publish: {
        locale: '',
        showHeading: true,
        narrow: {type: 'boolean', value: false, reflect: true},
      },
      localeChanged: function() {
        moment.locale(this.locale);
      },
      dateClicked: function(e) {
        var element = e.originalTarget ? e.originalTarget : e.toElement;
      },
      days: [],
      months: [],
      ready: function() {
        this.today = new Date();
        this.today.setHours(0, 0, 0, 0);
        // initialize core-selector
        this.super();
        this.narrow = false;
        this.weekdays = moment.weekdays();
        this.monthNames = moment.months();
        this.isTouch = 'ontouchstart' in window;
        this.localeChanged();
        this._populated = false;

        if (!this.value) {
          this.value = new Date();
        }
        if (!this.minYear) {
          this.minYear = this.value.getFullYear() - 0;
        }
        if (!this.maxYear) {
          this.maxYear = this.value.getFullYear() + 100;
        }
      },
      populate: function() {
        // populate calendar
        // TODO: is there a way for core-list to dynamically generate data on-demand?
        var initialYear = this.value.getFullYear();
        var year, month, date, days, padStart, padEnd, daysInMonth, m, d;
        month = new Date();
        for (year=this.minYear; year<=this.maxYear; year++) {
          month.setYear(year); 
          for (m=0; m<12; m++) {
            // get last day of the month
            month.setMonth(m+1);
            month.setDate(0);
            daysInMonth = month.getDate();
            padEnd = 6 - month.getDay();
            month.setYear(year);
            month.setMonth(m);
            month.setDate(1);
            padStart = month.getDay();
            days = [];
            for (d=0; d<padStart; d++) {
              days.push({});
            }
            for (d=1; d<=daysInMonth; d++) {
              date = new Date(year, m, d);
              days.push({
                date: date,
                isToday: date.getTime() == this.today.getTime()
              });
            }
            for (d=0; d<padEnd; d++) {
              days.push({});
            }
            this.months.push({
              month: m,
              year: year,
              days: days
            });
          }
        }
        this._populated = true;
      },
      changeDay: function() {
        this.$.pages.selected = 0;
      },
      changeMonth: function() {
        this.$.pages.selected = 1;
      },
      changeYear: function() {
        this.$.pages.selected = 2;
      },
      scrollToMonth: function(year, month) {
        var yearStart = (year - this.minYear) * 12;
        console.log('scrolling to ', yearStart + month);
        this.$.calendarList.scrollToItem(yearStart + month);
      },
      scrollToDate: function(date) {
        if (!date) {
          date = this.value;
        }
        this.scrollToMonth(date.getFullYear(), date.getMonth());
      },
      domReady: function() {
        this.populate();
        //this.scrollToDate(new Date());
      },
      selectedDateChanged: function() {
        this.value = this.selectedDate.date;
      },
      valueChanged: function() {
        console.log('valueChanged', this.value);
      },
    });

    PolymerExpressions.prototype.dateFormat = function(date, format) {
      if (!date) return '';
      return moment(date).format(format);
    };
  </script>
</polymer-element>
